from .BasePrompt import BasePrompt

# Recommended prompt structure: https://cookbook.openai.com/examples/gpt4-1_prompting_guide#recommended-workflow
# Role and Objective
# Instructions
## Sub-categories for more detailed instructions
# Reasoning Steps
# Output Format
# Examples
## Example 1
# Context
# Final instructions and prompt to think step by step
  
class TrajectoryQuery(BasePrompt): 
    def __init__(self,ref_img_encoded,ref_scene_graph,qa) -> None:
        '''
            scene_graph: scene graph of the location in text-serialized format.
            llm_scenario_out: output of the scenario generated by llm, parsed into a dictionary.
        '''
        
        super().__init__()
        self.payload = [
            {"role": "system", 
             "content": [{
                "type":"text",
                "text":"""
You are an expert floor planner and software engineer. Begin with a concise checklist (3-7 bullets) of what you will do; keep items conceptual, not implementation-level. Always provide output as a valid JSON object, fully parseable by Python's json.loads.
""" 
            }]
            },
            {
                "role": "user", 
                "content": [
                    {
                            "type":"text",
                            "text":"""
# Role and Objective
You are a helpful scenario design assistant that helps users to orchestrate human-robot scenarios by designing trajectories for the robot and humans in a given location. You will be given a scene graph json (a graph with nodes and edges of specific types), a map image of the location (with scene graph overlaid) and the user's [scenario description]. Your task is to design trajectories for the robot and the humans, and assign group IDs to the humans, to successfully execute the scenario in the given location while satisfying the user's scenario constraints.

# Instructions
You will recieve a [scenario description] from the user, which describes a human-robot scenario that needs to be orchestrated with certain constraints like where the robot encounters each human and which humans form groups. The scenario description will specify the number of humans, where they might encounter the robot and if any humans form groups.

You will receive a scene graph (in JSON format) and a binary overhead map image of the location where the scenario must be orchestrated (white part of the image is free space and the black/gray part is occupied space), overlaid with the corresponding scene graph showing the nodes and edges.

Your task is to design:
- 1 trajectory for each human (a continuous sequence of node ids from the scene graph for each human)
- 1 interaction point for each human (a single node id from the scene graph where the human interacts with the robot)
- group ID for each human (an integer for each human)
- 1 trajectory for the robot (a continuous sequence of node ids from the scene graph)

Design the trajectories to satisfy the following constraints: 
- Each trajectory should be a continuous sequence of nodes connected by edges from the scene graph.
- The robot should encounter every human in the scenairo at least once.
- The robot's trajectory must be atleast 3 nodes long
- Each human's trajectory must have at least 1 node in common with the robot's trajectory (the interaction point).
- Trajectories of humans in a group should be identical.
- Consider the direction of the humans' and robot's trajectory: Unless the user explictly requests a human chasing or following a robot, do not design trajectories where the human needs to chase the robot to interact with it. In many cases this might not happen because humans walk slowly and therefore might not encounter the robot. Thus, try to design trajectories where the human and robot are moving towards or orthogonal to each other at the interaction point. This increases the likelihood of interaction.
- Whenever possible, try not to make the interaction point the first or last node of the robot or the human's trajectory. Try to make the robot and human move from and to other nodes before and after the interaction point.

Because Sometimes the user might request a scenario involving multiple humans that act as a single entity called a 'group', you must also assign a 'group ID' for each human. If a set of humans form a group, they will have the same non-negative group ID. If a human is not part of any group, they have group ID = -1. 
The user's scenario description will explicitly specify when humans are part of a group, so read and understand the scenario description very carefully and assign group IDs accordingly.

Assign group IDs to the humans according to the following rules:
- All the members of the same group must have the same group id.
- If a human is not involved in a group, they will have a group id of -1.
- If the scenario does not explicitly mention a group, then assign -1 to all humans
- Be careful with assigning group ids. 2 humans with the same group id will influence each other's trajectories. Therefore, for example, "one human following another" ARE NOT IN a group. while "2 humans walking together" ARE IN a group. 
- All humans involved in the scenario must be assigned a group id.


# Output Format 
Provide reasoning for your scenario, trajectory, and group id choices in the 'reasoning' field. Include all required scenario logic, but do not add custom or non-parsable fields; output only the required fields below.
Always respond with a JSON object containing:
- 'reasoning': <reasoning behind your trajectory and group id choices>,
- 'trajectories': {
    'robot': [node 1 ID, node 2 ID, ....], # Robot trajectory as a sequence of scene graph node IDs
    'humans':[
            {
                'name': 'human 1',
                'groupid': <group id integer>,
                'trajectory': [node 1 ID, node 2 ID, ....], # Human 1 trajectory as a sequence of scene graph node IDs
                'interaction_point': <node ID> # Interaction point node ID for human 1
            },
            {
                'name': 'human 2',
                'groupid': <group id integer>,
                'trajectory': [node 1 ID, node 2 ID, ....], # Human 2 trajectory as a sequence of scene graph node IDs
                'interaction_point': <node ID> # Interaction point node ID for human 2
            },
            ... <- add as many entries as there are humans in the scenario description
            ]
        }
- All JSON objects and arrays must use double quotes for keys and string values; ensure output is valid JSON.
- All fields are mandatory for each agent; do not omit or add fields.
- If scenario constraints cannot be satisfied due to the scene graph (e.g., not enough SIMPLE EDGE nodes for three separate humans), explain this in the 'reasoning' field but still provide as complete an output as possible according to the schema.
- List humans logically in the 'humans' array, e.g., groups first, then individuals, or as mentioned in the prompt.
- Do not include any prose or information outside of this JSON structure.
After producing your output, validate that the JSON is parseable and adheres strictly to the schema; if an error is found, minimally self-correct and re-emit the output.

# Reasoning Steps
1. Scenario Trajectory constraints: What interaction locations does the scenario specify? What other locations does the scenario imply or suggest for the robot and humans to traverse through? Which nodes and edges are candidates for these locations?
2. Interaction Locations: Which nodes or edges does the robot interact with each human at to satisfy the scenario? 
3. Group IDs: Which humans are in a group and which humans are independent?
4. Robot Trajectory: What trajectory should the robot take to satisfy all interaction points and other scenario constraints?
5. Human Trajectories: What trajectory should each human take to satisfy their interaction point and other scenario constraints?

# Examples
Below is the scene graph image and json for the sample location used in the examples.
        """
                    },
                    {         
                        "type":"image_url",
                        "image_url":{
                            "url":f"data:image/jpeg;base64,{ref_img_encoded}",
                            "detail":"high"
                        }
                    },
                    {
                        "type":"text",
                        "text":f"""Scene Graph JSON:{ref_scene_graph}"""
                    }
                ]
            }
        ]
        
        for i,item in enumerate(qa):
            if i == 0:
                self.payload[-1]['content'].append(
                    {
                "type":"text",
                "text":item[0] #question
                }
                )
            else:
                self.payload.append({
                    "role":"user",
                    "content":[{
                    "type":"text",
                    "text":item[0] #question
                }]})
            
            self.payload.append({
                "role":"assistant",
                "content":[{
                "type":"text",
                "text":item[1] #answer
            }]})
        
        
    def get_full_prompt(self,**kwargs):
        full_prompt = self.payload
        self.payload.append(
            {"role": "user", "content": [{"type":"text","text":f"""
Now consider a new location with the following scene graph: 
{kwargs['scene_graph']}
The Node are of type: {kwargs['node_types']} while the edges are of type: {kwargs['edge_types']}. 
The map image with the scene graph is given in the next image."""},
{
    "type":"image_url",
    "image_url":{
        "url":f"data:image/jpeg;base64,{kwargs['encoded_img']}"
    }
},
{"type":"text",
"text":"""

# Final Instructions
Here's the output format again for your reference:
- 'reasoning': <Step by Step reasoning as shown in examples>,
- 'trajectories': {
    'robot': [node 1 ID, node 2 ID, ....], # Robot trajectory as a sequence of scene graph node IDs
    'humans':[
            {
                'name': 'human 1',
                'groupid': <group id integer>,
                'trajectory': [node 1 ID, node 2 ID, ....], # Human 1 trajectory as a sequence of scene graph node IDs
                'interaction_point': <node ID> # Interaction point node ID for human 1
            },
            {
                'name': 'human 2',
                'groupid': <group id integer>,
                'trajectory': [node 1 ID, node 2 ID, ....], # Human 2 trajectory as a sequence of scene graph node IDs
                'interaction_point': <node ID> # Interaction point node ID for human 2
            },
            ... <- add as many entries as there are humans in the scenario description
            ]}
        }

Q: Parse the following scenrio description:

<SCENARIO DESCRIPTION>

A:
"""}]}
        )
        
        full_prompt[-1]["content"][-1]["text"] = full_prompt[-1]["content"][-1]["text"].replace('<SCENARIO DESCRIPTION>',kwargs['sc_desc'])  
        #print(full_prompt)
        return full_prompt